library(tidyverse)


#' Get mean of metric values, for new code.
#' 
#' @param results_dir Directory containing a file results.txt which is created
#' by npDR().
#' @param var One of "bias", "mse", "width", or "cov" (for coverage).
#' @param write Logical. If TRUE, then write output to results_dir.
#' @return A vector of mean values for the chosen var. Means are taken over
#' all the simulations represented in results.txt.
calc_means <- function(results_dir, var, write=TRUE, append=TRUE) {
  dat <- read.table(file.path(paste0(results_dir, "/results.txt")), header=TRUE)
  out <- dat %>%
    filter(metric == var) %>%
    dplyr::select(-c("metric", "counter", "N")) %>%
    summarize_all(mean) %>%
    gather(key = "estimator_simulation")
  if (write) {
    write_tsv(as.data.frame(t(out)),
              file.path(paste0(results_dir, "/", var, ".txt")),
              append = append)    
  }
  invisible(out)
}

#' Get mean of metric values, for the old code.
#' 
#' @param results_dir Directory containing a file results.txt which is created
#' by npDR().
#' @param metric One of "bias", "rmse" (which is actually mse), "width", or
#' "cov" (for coverage).
#' @param write Logical. If TRUE, then write output to results_dir.
#' @return A vector of mean values for the chosen metric. Means are taken over
#' all the simulations represented in results.txt.
calc_means <- function(results_dir, metric, write=TRUE) {
  dat <- read.table(file.path(paste0(results_dir, "/results.txt")), header=TRUE)
  out <- dat %>%
    filter(type == metric) %>%
    dplyr::select(-c("N", "type")) %>%
    colMeans  
  if (write) {
    write_tsv(as.data.frame(t(out)),
              file.path(paste0(results_dir, "/", metric, ".txt")))    
  }
  invisible(out)
}


#' Get directories containing results, for downstream processing.
#' 
#' @param topdir The top directory to look in.
#' @param exclude A string representing directories to exclude. If NULL, then
#' all directories starting with "results" are included. If non-NULL, then all
#' directories containing this string are excluded.
#' @return A vector of paths to subdirectories in the top directory which start
#' with "results".
get_dirs <- function(topdir=".", exclude=NULL) {
  out <- list.dirs(topdir, recursive=FALSE) %>%
    magrittr::extract(startsWith(., "./results"))
  if (!is.null(exclude)) {
    out <- out[!grepl(exclude, out, fixed=TRUE)]
  }
  return(out) 
}


#' Process the results file that is generated by simulate_inference().
#' 
#' Computes the mean metric value across a given set of simulations.
#' @param results_dir Path to a directory containing a file results.txt
#' generated by npDR().
#' @param metrics Some subset of c("bias", "mse", "width", "cov").
#' @return None. Writes one file per chosen metric to the results_dir.
metric_means <- function(results_file, append,
                            vars=c("est", "se", "bias", "mse", "width", "cov")) {
  outdir <- dirname(results_file)
  # if (file.exists(outfile)) {
  #   header = FALSE
  # }
  # else {
  #   header = TRUE
  # }
  dat <- read.table(results_file, header=TRUE)
  for (var in vars) {
    print(var)
    dat %>%
      filter(metric == var) %>%
      dplyr::select(-c("metric", "counter")) %>%
      group_by(N) %>%
      summarize_all(mean) %>%
      gather(key = "estimator_simulation", value = "value", -N) %>%
      write_tsv(file.path(paste0(outdir, "/", var, ".txt")), append = append) 
  }
}


#' Aggregate and save coverage results from different runs.
# aggregate_results <- function(metric, results_dirs, digits=3) {
#   out <- sapply(results_dirs, function(d) {
#     return(read.table(paste0(d, "/", metric, ".txt"), header=TRUE))
#   }, simplify = FALSE, USE.NAMES = TRUE) %>%
#     bind_rows(.id = "source") %>%
#     mutate(source = str_replace(source, "./results_", "")) %>%
#     mutate_if(is.numeric, round, digits=digits)
#   write_tsv(out, file.path(paste0("./", metric, "_aggregated.txt"))) 
#   invisible(out)
# }

#' Aggregate averaged metric values from different runs.
aggregate_mean_results <- function(metric, results_dirs, digits=3) {
  out <- sapply(results_dirs, function(d) {
    return(read_tsv(paste0(d, "/", metric, ".txt"), col_names = TRUE))
  }, simplify = FALSE, USE.NAMES = TRUE) %>%
    bind_rows(.id = "source") %>%
    mutate(source = str_replace(source, "./results_", "")) %>%
    mutate_if(is.numeric, round, digits=digits)
  write_tsv(out, file.path(paste0("./", metric, "_aggregated.txt"))) 
  invisible(out)
}


#' Aggregate averaged metric values from different runs.
aggregate_raw_results <- function(files) {
  out <- sapply(files, function(d) {
    d %>%
      read.table(header = TRUE) %>%
      gather(key = "estimator_simulation", value = "value", -c(metric, counter, N)) %>%
      return
  }, simplify = FALSE, USE.NAMES = TRUE) %>%
    bind_rows(.id = "source") %>%
    mutate(source = str_replace(source, "./results_", "")) %>%
    mutate(source = str_replace(source, "/results.+$", "")) %>%
    arrange(source, counter)
  write_tsv(out, file.path(paste0("./results_raw_aggregated.txt"))) 
  invisible(out)
}


#' Plot results.
plot_metric <- function(filename, sources, metric, write=TRUE, suffix="") {
  dat <- read_tsv(filename)
  ymax <- max(abs(dat$value), na.rm=TRUE)*1.05
  dat <- dat %>%
    filter(source %in% sources) %>%
    # gather(key = "estimator", value = "value", -source) %>%
    # separate(estimator, c("estimator", "model", "confounder"), c(-3, -1)) %>%
    separate(estimator_simulation, c("estimator", "simulation"), sep = "_") %>%
    mutate(value = abs(value)) %>%
    mutate(source = factor(source)) %>%
    mutate(estimator = factor(estimator, levels = c("ipw", "gcomp", "aipw", "tmle"))) %>%
    mutate(simulation = factor(simulation, levels = c("FNP", "TNP", "FPM", "TPM", "oracle"))) %>%
    mutate(simulation = fct_recode(simulation, Oracle = "oracle"))
  p <- ggplot(dat, aes(x=0, y=value, fill=estimator)) + 
    geom_col(position = "dodge") +
    facet_grid(simulation ~ N) +
    xlab("Sample Size") +
    ylab(metric) +
    ylim(c(0, ymax)) +
    ggtitle(paste(metric, "under different simulation conditions")) +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.grid.major = element_blank())
          # strip.text.x = element_text(size = 6, angle = 45))
  if (write) {
    ggsave(paste0("./", metric, suffix, ".pdf"), p, height=6, width=8)
  }
  return(p)
}